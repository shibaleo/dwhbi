# 全トランザクションデータ同期ガイド

## 概要

Zaimの全トランザクションデータをSupabaseに安全に同期するための手順です。

## 安全性への配慮

### レート制限対策
- **月次分割**: 全期間を一度に取得せず、月ごとに分割して同期
- **待機時間**: 各月の同期後に1秒の待機（調整可能）
- **自動判定**: データ開始時期を自動検出し、無駄なAPI呼び出しを削減

### エラー対応
- **再開機能**: エラー発生時、途中から再開可能
- **進捗表示**: リアルタイムで進捗と予想残り時間を表示
- **詳細ログ**: 各月の同期結果を記録

## 実行フロー

```
1. テスト実行 (test_sync_all.ts)
   ↓
2. テスト結果の確認
   ↓
3. 本番実行 (sync_all_transactions.ts)
```

---

## ステップ1: テスト実行

まず小規模なテストで動作確認を行います。

### 実行コマンド

```bash
deno run --allow-net --allow-env --allow-read test_sync_all.ts
```

### テスト内容

1. **直近30日間の同期テスト**
   - 少量データでの動作確認
   - 処理速度の測定
   - 全期間同期の所要時間を推定

2. **単月同期テスト**
   - 今月のデータで動作確認

3. **レート制限テスト**
   - 3ヶ月分を連続同期
   - API制限に引っかからないか確認

### 期待される出力

```
✅ すべてのテストが成功しました
次のステップ: sync_all_transactions.ts の実装が可能です
```

### テスト失敗時の対応

- **API認証エラー**: `.env`ファイルのZaim認証情報を確認
- **レート制限エラー**: 待機時間を延長（後述の設定変更）
- **データベースエラー**: Supabaseの接続情報を確認

---

## ステップ2: 本番実行

テストが成功したら、全期間の同期を実行します。

### 基本実行（推奨）

```bash
deno run --allow-net --allow-env --allow-read sync_all_transactions.ts
```

自動的に以下を実行：
- データ開始年月の自動判定
- 現在までの全期間を月次で同期
- 各月の後に1秒待機

### 実行例

#### 1. 全期間同期（自動判定）
```typescript
const allSync = new AllTransactionSync();
await allSync.syncAll();
```

#### 2. 開始年月を指定
```typescript
await allSync.syncAll({ 
  startYear: 2020, 
  startMonth: 1 
});
```

#### 3. 直近N年間のみ同期
```typescript
await allSync.syncRecentYears(3); // 直近3年間
```

#### 4. 特定期間を同期
```typescript
await allSync.syncRange(2020, 1, 2023, 12); // 2020/1 〜 2023/12
```

#### 5. 途中から再開
```typescript
// エラーで中断した場合
await allSync.syncAll({ 
  resumeFrom: '2022-06'  // 2022年6月から再開
});
```

### カスタマイズ

待機時間を調整する場合：

```typescript
await allSync.syncAll({
  delayBetweenMonths: 2000  // 2秒に延長（レート制限が厳しい場合）
});
```

---

## 進捗表示の見方

実行中は以下のような進捗が表示されます：

```
────────────────────────────────────────────────────────────
📊 進捗状況
────────────────────────────────────────────────────────────
  期間: 2020-01 〜 2024-11
  進行: 24/59月 (40.7%)
  現在: 2022-01
  累計: 3,542件取得
  今月: +127件 (挿入:45, 更新:82)
  経過時間: 12.3分
  予想残り: 17.8分
────────────────────────────────────────────────────────────
```

---

## 推定実行時間

テスト結果に基づく推定例：

| データ量 | 期間 | 推定時間 |
|---------|------|---------|
| 少量（月10件） | 5年間 | 約5分 |
| 中量（月50件） | 5年間 | 約15分 |
| 大量（月200件） | 5年間 | 約30分 |

※ネットワーク速度とAPI応答時間により変動します

---

## トラブルシューティング

### エラーで中断した場合

1. エラーメッセージを確認
2. 表示された年月から再開：

```typescript
await allSync.syncAll({ resumeFrom: '2022-06' });
```

### レート制限エラー

待機時間を延長：

```typescript
await allSync.syncAll({ 
  delayBetweenMonths: 3000  // 3秒
});
```

### メモリ不足エラー

期間を分割して実行：

```typescript
// 2020-2021年
await allSync.syncRange(2020, 1, 2021, 12);

// 2022-2023年
await allSync.syncRange(2022, 1, 2023, 12);

// 2024年〜現在
await allSync.syncRange(2024, 1, 2024, 11);
```

---

## データ確認

同期後、Supabaseで以下のクエリでデータを確認：

```sql
-- 月別トランザクション数
SELECT 
  TO_CHAR(date, 'YYYY-MM') as month,
  COUNT(*) as count
FROM zaim_transactions
WHERE zaim_user_id = YOUR_USER_ID
GROUP BY TO_CHAR(date, 'YYYY-MM')
ORDER BY month;

-- 最古・最新のデータ
SELECT 
  MIN(date) as oldest,
  MAX(date) as newest,
  COUNT(*) as total
FROM zaim_transactions
WHERE zaim_user_id = YOUR_USER_ID;
```

---

## 注意事項

### 実行前
- [ ] `.env`ファイルの設定確認
- [ ] テストの成功確認
- [ ] 十分な実行時間の確保（推定時間 + バッファ）

### 実行中
- [ ] 進捗表示の監視
- [ ] エラーメッセージの記録
- [ ] ネットワーク接続の安定性確認

### 実行後
- [ ] 同期ログテーブル（`zaim_sync_log`）の確認
- [ ] データ件数の確認
- [ ] 最古・最新データの確認

---

## よくある質問

**Q: 既存データは重複しませんか？**  
A: `upsert`を使用しているため、既存データは更新され、重複しません。

**Q: 途中で止めても大丈夫ですか？**  
A: はい。月単位で完了しているため、途中から再開できます。

**Q: レート制限はどのくらいですか？**  
A: Zaim APIの公式制限は不明ですが、月間1秒待機で問題なく動作します。

**Q: 何度も実行しても大丈夫ですか？**  
A: はい。冪等性があるため、何度実行しても最新の状態に同期されます。

---

## 次のステップ

1. GitHub Actionsでの定期実行設定
2. 増分同期（新規データのみ）の実装
3. データ分析・可視化