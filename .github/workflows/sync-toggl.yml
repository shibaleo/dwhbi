name: Sync Toggl Daily

on:
  schedule:
    # 毎日 JST 00:00 (UTC 15:00) に実行
    - cron: '0 15 * * *'
  
  # 手動実行も可能
  workflow_dispatch:

jobs:
  sync:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
      
      - name: Setup Deno
        uses: denoland/setup-deno@v1
        with:
          deno-version: v1.x
      
      - name: Create .env file
        run: |
          echo "TOGGL_API_TOKEN=${{ secrets.TOGGL_API_TOKEN }}" >> .env
          echo "TOGGL_WORKSPACE_ID=${{ secrets.TOGGL_WORKSPACE_ID }}" >> .env
          echo "SUPABASE_URL=${{ secrets.SUPABASE_URL }}" >> .env
          echo "SUPABASE_SERVICE_ROLE_KEY=${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}" >> .env
      
      - name: Run sync script
        run: |
          deno run \
            --allow-net \
            --allow-read \
            --allow-env \
            sync_daily.ts
      
      - name: Notify on failure
        if: failure()
        run: |
          echo "Sync failed at $(TZ=Asia/Tokyo date '+%Y-%m-%d %H:%M:%S JST')"