name: All Services Daily Sync

on:
  # 毎日 JST 00:00 に実行（UTC 15:00）
  #schedule:
  #  - cron: "0 15 * * *"

  # 手動実行を許可
  workflow_dispatch:
    inputs:
      toggl_sync_days:
        description: "Toggl: 同期日数"
        required: false
        default: "3"
        type: string
      tanita_sync_days:
        description: "Tanita: 同期日数"
        required: false
        default: "3"
        type: string
      zaim_sync_days:
        description: "Zaim: 同期日数"
        required: false
        default: "7"
        type: string
      gcal_sync_days:
        description: "Google Calendar: 同期日数"
        required: false
        default: "3"
        type: string
      fitbit_sync_days:
        description: "Fitbit: 同期日数"
        required: false
        default: "3"
        type: string
      trello_full_sync:
        description: "Trello: 全アクションを取得（差分ではなく全取得）"
        required: false
        default: "false"
        type: string
      ticktick_sync_days:
        description: "TickTick: 完了タスク同期日数"
        required: false
        default: "7"
        type: string
      skip_dbt:
        description: "dbt実行をスキップ"
        required: false
        default: "false"
        type: string

jobs:
  sync-all:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: ./.github/actions/python-setup

      - name: Run all services sync
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_SERVICE_ROLE_KEY: ${{ secrets.SUPABASE_SERVICE_ROLE_KEY }}
          DIRECT_DATABASE_URL: ${{ secrets.DIRECT_DATABASE_URL }}
          TOGGL_SYNC_DAYS: ${{ inputs.toggl_sync_days || '3' }}
          TANITA_SYNC_DAYS: ${{ inputs.tanita_sync_days || '3' }}
          ZAIM_SYNC_DAYS: ${{ inputs.zaim_sync_days || '7' }}
          GCAL_SYNC_DAYS: ${{ inputs.gcal_sync_days || '3' }}
          FITBIT_SYNC_DAYS: ${{ inputs.fitbit_sync_days || '3' }}
          TRELLO_FULL_SYNC: ${{ inputs.trello_full_sync || 'false' }}
          TICKTICK_SYNC_DAYS: ${{ inputs.ticktick_sync_days || '7' }}
        run: |
          python -c "
          import asyncio
          import os
          from pipelines.services.toggl_track.orchestrator import sync_all as sync_toggl
          from pipelines.services.tanita import sync_tanita
          from pipelines.services.zaim import sync_zaim
          from pipelines.services.google_calendar.orchestrator import sync_all as sync_gcalendar
          from pipelines.services.fitbit import sync_fitbit
          from pipelines.services.trello import sync_trello
          from pipelines.services.ticktick import sync_ticktick

          async def run_all():
              results = {}
              errors = []

              # Toggl
              try:
                  days = int(os.environ.get('TOGGL_SYNC_DAYS', '3'))
                  result = await sync_toggl(days=days)
                  results['toggl'] = result
                  print(f'✅ Toggl: {result}')
              except Exception as e:
                  errors.append(f'Toggl: {e}')
                  print(f'❌ Toggl: {e}')

              # Tanita
              try:
                  days = int(os.environ.get('TANITA_SYNC_DAYS', '3'))
                  result = await sync_tanita(days=days)
                  results['tanita'] = result
                  print(f'✅ Tanita: {result}')
              except Exception as e:
                  errors.append(f'Tanita: {e}')
                  print(f'❌ Tanita: {e}')

              # Zaim
              try:
                  days = int(os.environ.get('ZAIM_SYNC_DAYS', '7'))
                  result = await sync_zaim(days=days)
                  results['zaim'] = result
                  print(f'✅ Zaim: {result}')
              except Exception as e:
                  errors.append(f'Zaim: {e}')
                  print(f'❌ Zaim: {e}')

              # Google Calendar
              try:
                  days = int(os.environ.get('GCAL_SYNC_DAYS', '3'))
                  result = await sync_gcalendar(days=days)
                  results['gcalendar'] = result
                  print(f'✅ Google Calendar: {result}')
              except Exception as e:
                  errors.append(f'Google Calendar: {e}')
                  print(f'❌ Google Calendar: {e}')

              # Fitbit
              try:
                  days = int(os.environ.get('FITBIT_SYNC_DAYS', '3'))
                  result = await sync_fitbit(days=days)
                  results['fitbit'] = result
                  print(f'✅ Fitbit: {result}')
              except Exception as e:
                  errors.append(f'Fitbit: {e}')
                  print(f'❌ Fitbit: {e}')

              # Trello (差分同期)
              try:
                  full_sync = os.environ.get('TRELLO_FULL_SYNC', 'false').lower() == 'true'
                  result = await sync_trello(full_sync=full_sync)
                  results['trello'] = result
                  print(f'✅ Trello: {result}')
              except Exception as e:
                  errors.append(f'Trello: {e}')
                  print(f'❌ Trello: {e}')

              # TickTick
              try:
                  days = int(os.environ.get('TICKTICK_SYNC_DAYS', '7'))
                  result = await sync_ticktick(days=days)
                  results['ticktick'] = result
                  print(f'✅ TickTick: {result}')
              except Exception as e:
                  errors.append(f'TickTick: {e}')
                  print(f'❌ TickTick: {e}')

              if errors:
                  print(f'\\n⚠️ {len(errors)} service(s) failed')
                  for error in errors:
                      print(f'  - {error}')
                  exit(1)
              else:
                  print('\\n✅ All services synced successfully')

          asyncio.run(run_all())
          "

      - name: Setup dbt environment
        if: inputs.skip_dbt != 'true'
        env:
          DIRECT_DATABASE_URL: ${{ secrets.DIRECT_DATABASE_URL }}
        run: |
          python -c "
          import os
          from urllib.parse import urlparse

          url = os.environ['DIRECT_DATABASE_URL']
          parsed = urlparse(url)

          with open(os.environ['GITHUB_ENV'], 'a') as f:
              f.write(f'DBT_SUPABASE_HOST={parsed.hostname}\n')
              f.write(f'DBT_SUPABASE_PORT={parsed.port or 5432}\n')
              f.write(f'DBT_SUPABASE_USER={parsed.username}\n')
              f.write(f'DBT_SUPABASE_PASSWORD={parsed.password}\n')
              f.write(f'DBT_SUPABASE_DB={parsed.path.lstrip(\"/\")}\n')

          print(f'✅ dbt environment configured for {parsed.hostname}')
          "

      - name: Install dbt packages
        if: inputs.skip_dbt != 'true'
        working-directory: transform
        run: dbt deps

      - name: Run dbt models
        if: inputs.skip_dbt != 'true'
        working-directory: transform
        run: dbt run

      - name: Run dbt tests
        if: inputs.skip_dbt != 'true'
        working-directory: transform
        run: dbt test

      - name: Notify on failure
        if: failure()
        run: |
          echo "❌ 同期またはdbt実行が失敗しました"
          echo "詳細は上記ログを確認してください"
