name: dbt Run

on:
  # 手動実行
  workflow_dispatch:
    inputs:
      command:
        description: "dbt command to run"
        required: false
        default: "run"
        type: choice
        options:
          - run
          - test
          - build
          - "run --select staging.toggl_track"
      full_refresh:
        description: "Full refresh (--full-refresh)"
        required: false
        default: false
        type: boolean
      run_tests:
        description: "Run tests after command"
        required: false
        default: true
        type: boolean

  # 他のワークフローから呼び出し可能
  workflow_call:
    inputs:
      command:
        description: "dbt command to run"
        required: false
        default: "run"
        type: string
    secrets:
      DIRECT_DATABASE_URL:
        required: true

jobs:
  dbt-run:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install dbt-postgres python-dotenv

      - name: Install dbt packages
        env:
          DIRECT_DATABASE_URL: ${{ secrets.DIRECT_DATABASE_URL }}
        run: python packages/transform/scripts/run_dbt.py deps

      - name: Run dbt debug
        env:
          DIRECT_DATABASE_URL: ${{ secrets.DIRECT_DATABASE_URL }}
        run: python packages/transform/scripts/run_dbt.py debug

      - name: Run dbt command
        env:
          DIRECT_DATABASE_URL: ${{ secrets.DIRECT_DATABASE_URL }}
        run: |
          COMMAND="${{ inputs.command || 'run' }}"
          FULL_REFRESH="${{ inputs.full_refresh }}"

          echo "Running: dbt $COMMAND"

          if [ "$FULL_REFRESH" = "true" ]; then
            python packages/transform/scripts/run_dbt.py $COMMAND --full-refresh
          else
            python packages/transform/scripts/run_dbt.py $COMMAND
          fi

      - name: Run dbt tests
        if: inputs.run_tests == true || inputs.run_tests == 'true'
        env:
          DIRECT_DATABASE_URL: ${{ secrets.DIRECT_DATABASE_URL }}
        run: python packages/transform/scripts/run_dbt.py test

      - name: Generate dbt docs
        env:
          DIRECT_DATABASE_URL: ${{ secrets.DIRECT_DATABASE_URL }}
        run: python packages/transform/scripts/run_dbt.py docs generate

      - name: Notify on failure
        if: failure()
        run: |
          echo "❌ dbt実行が失敗しました"
          echo "詳細は Actions ログを確認してください"
