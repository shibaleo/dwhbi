name: dbt Run

on:
  # 手動実行
  workflow_dispatch:
    inputs:
      command:
        description: "dbt command to run"
        required: false
        default: "run"
        type: choice
        options:
          - run
          - test
          - build
          - "run --select staging.toggl_track"
      full_refresh:
        description: "Full refresh (--full-refresh)"
        required: false
        default: false
        type: boolean
      run_tests:
        description: "Run tests after command"
        required: false
        default: true
        type: boolean

  # 他のワークフローから呼び出し可能
  workflow_call:
    inputs:
      command:
        description: "dbt command to run"
        required: false
        default: "run"
        type: string
    secrets:
      DIRECT_DATABASE_URL:
        required: true

jobs:
  dbt-run:
    runs-on: ubuntu-latest
    timeout-minutes: 10

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Setup Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.12"

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Setup dbt environment
        env:
          DIRECT_DATABASE_URL: ${{ secrets.DIRECT_DATABASE_URL }}
        run: |
          python -c "
          import os
          from urllib.parse import urlparse

          url = os.environ['DIRECT_DATABASE_URL']
          parsed = urlparse(url)

          with open(os.environ['GITHUB_ENV'], 'a') as f:
              f.write(f'DBT_SUPABASE_HOST={parsed.hostname}\n')
              f.write(f'DBT_SUPABASE_PORT={parsed.port or 5432}\n')
              f.write(f'DBT_SUPABASE_USER={parsed.username}\n')
              f.write(f'DBT_SUPABASE_PASSWORD={parsed.password}\n')
              f.write(f'DBT_SUPABASE_DB={parsed.path.lstrip(\"/\")}\n')

          print(f'✅ dbt environment configured for {parsed.hostname}')
          "

      - name: Install dbt packages
        working-directory: transform
        run: dbt deps

      - name: Run dbt debug
        working-directory: transform
        run: dbt debug

      - name: Run dbt command
        working-directory: transform
        run: |
          COMMAND="${{ inputs.command || 'run' }}"
          FULL_REFRESH="${{ inputs.full_refresh }}"

          echo "Running: dbt $COMMAND"

          if [ "$FULL_REFRESH" = "true" ]; then
            dbt $COMMAND --full-refresh
          else
            dbt $COMMAND
          fi

      - name: Run dbt tests
        if: inputs.run_tests == true || inputs.run_tests == 'true'
        working-directory: transform
        run: dbt test

      - name: Generate dbt docs
        working-directory: transform
        run: dbt docs generate

      - name: Notify on failure
        if: failure()
        run: |
          echo "❌ dbt実行が失敗しました"
          echo "詳細は Actions ログを確認してください"
