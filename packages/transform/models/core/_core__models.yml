# Core Layer Models
# =============================================================================
# ビジネスエンティティのスキーマ定義とテスト
# =============================================================================

version: 2

models:
  # ===========================================================================
  # Master Tables
  # ===========================================================================
  - name: mst_time_projects
    description: |
      Togglプロジェクトマスタ（Codaメタデータ統合）

      Features:
      - stg_toggl_track__projects: Toggl APIからのプロジェクトデータ
      - stg_toggl_track__clients: クライアント名
      - stg_coda__mst_toggl_projects: Codaからの補足情報（sort_order, name_ja）
    columns:
      - name: project_id
        description: "TogglプロジェクトID（PK）"
        data_tests:
          - unique
          - not_null
      - name: project_name
        description: "プロジェクト名"
        data_tests:
          - not_null
      - name: project_color
        description: "プロジェクト色（HEX）"
      - name: client_id
        description: "クライアントID（FK）"
      - name: client_name
        description: "クライアント名"
      - name: name_ja
        description: "日本語名（Codaから）"
      - name: description
        description: "説明（Codaから）"
      - name: sort_order
        description: "表示順（Codaから、デフォルト999）"
        data_tests:
          - not_null
      - name: is_active
        description: "アクティブフラグ"
      - name: is_private
        description: "プライベートフラグ"
      - name: is_billable
        description: "請求可能フラグ"
      - name: created_at
        description: "作成日時"
      - name: updated_at
        description: "更新日時"

  # ===========================================================================
  # Fact Tables
  # ===========================================================================
  - name: fct_time_records_actual
    description: |
      Togglからの実績時間レコード（エントリー単位、分割なし）

      Features:
      - 元のエントリーをそのまま保持（日跨ぎ分割なし）
      - 進行中レコード: end_at = CURRENT_TIMESTAMP (NOT NULL保証)
      - プロジェクト色・クライアントからのカテゴリマッピング
      
      Use case:
      - 睡眠分析（1セッション単位）
      - エントリー単位の所要時間分析
    columns:
      - name: id
        description: "ユニークID（source_id）"
        data_tests:
          - unique
          - not_null
      - name: source_id
        description: "元のToggl time_entry_id"
        data_tests:
          - not_null
      - name: start_at
        description: "開始時刻（JST）"
        data_tests:
          - not_null
      - name: end_at
        description: "終了時刻（JST）"
        data_tests:
          - not_null
      - name: duration_seconds
        description: "時間（秒）"
        data_tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1
      - name: description
        description: "Togglのdescription"
      - name: project_name
        description: "Togglのプロジェクト名"
      - name: project_color
        description: "Togglのプロジェクト色（HEX）"
      - name: tag_names
        description: "Togglのタグ名配列（text[]）"
      - name: social_category
        description: "社会的分類（WORK, LEISURE等）"
        data_tests:
          - not_null
      - name: personal_category
        description: "個人的分類（Work, Study等）"
        data_tests:
          - not_null
      - name: source
        description: "データソース"
        data_tests:
          - not_null
          - accepted_values:
              values: ['toggl_track']

  - name: fct_time_records_actual_split
    description: |
      Togglからの実績時間レコード（日分割版）

      Features:
      - JST 00:00:00 境界での日跨ぎ分割
      - 進行中レコード: end_at = CURRENT_TIMESTAMP (NOT NULL保証)
      - プロジェクト色・クライアントからのカテゴリマッピング
      
      Use case:
      - 日別集計
      - 日境界での時間分析
    columns:
      - name: id
        description: "ユニークID（{source_id}_{split_index}）"
        data_tests:
          - unique
          - not_null
      - name: source_id
        description: "元のToggl time_entry_id"
        data_tests:
          - not_null
      - name: start_at
        description: "開始時刻（JST、分割後）"
        data_tests:
          - not_null
      - name: end_at
        description: "終了時刻（JST、分割後）"
        data_tests:
          - not_null
      - name: duration_seconds
        description: "時間（秒）"
        data_tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1
      - name: description
        description: "Togglのdescription"
      - name: project_name
        description: "Togglのプロジェクト名"
      - name: project_color
        description: "Togglのプロジェクト色（HEX）"
      - name: tag_names
        description: "Togglのタグ名配列（text[]）"
      - name: social_category
        description: "社会的分類（WORK, LEISURE等）"
        data_tests:
          - not_null
      - name: personal_category
        description: "個人的分類（Work, Study等）"
        data_tests:
          - not_null
      - name: source
        description: "データソース"
        data_tests:
          - not_null
          - accepted_values:
              values: ['toggl_track']

  - name: fct_time_records_target
    description: |
      Google Calendarからの目標時間レコード（エントリー単位、分割なし）

      Features:
      - 元のエントリーをそのまま保持（日跨ぎ分割なし）
      - summary → mst_time_projects.project_nameでプロジェクトマッピング
      - プロジェクト色・クライアントからのカテゴリマッピング
      - キャンセル済みイベント除外
      - fct_time_records_actualと同一列構成

      Use case:
      - エントリー単位の所要時間分析
    columns:
      - name: id
        description: "ユニークID（source_id）"
        data_tests:
          - unique
          - not_null
      - name: source_id
        description: "元のGCal event_id"
        data_tests:
          - not_null
      - name: start_at
        description: "開始時刻（UTC timestamptz）"
        data_tests:
          - not_null
      - name: end_at
        description: "終了時刻（UTC timestamptz）"
        data_tests:
          - not_null
      - name: duration_seconds
        description: "時間（秒）"
        data_tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1
      - name: description
        description: "GCalのsummary"
      - name: project_name
        description: "プロジェクト名"
        data_tests:
          - not_null
      - name: project_color
        description: "プロジェクト色（HEX）"
        data_tests:
          - not_null
      - name: tag_names
        description: "タグ名配列（text[]）"
        data_tests:
          - not_null
      - name: social_category
        description: "社会的分類（WORK, LEISURE等）"
        data_tests:
          - not_null
      - name: personal_category
        description: "個人的分類（Work, Study等）"
        data_tests:
          - not_null
      - name: coarse_personal_category
        description: "粗い個人的分類"
        data_tests:
          - not_null
      - name: social_order
        description: "Social分類のソート順"
        data_tests:
          - not_null
      - name: personal_order
        description: "Personal分類のソート順"
        data_tests:
          - not_null
      - name: coarse_order
        description: "粗いPersonal分類のソート順"
        data_tests:
          - not_null
      - name: project_order
        description: "プロジェクトのソート順"
        data_tests:
          - not_null
      - name: source
        description: "データソース"
        data_tests:
          - not_null
          - accepted_values:
              values: ['google_calendar']

  - name: fct_time_records_target_split
    description: |
      Google Calendarからの目標時間レコード（日分割版）

      Features:
      - JST 00:00:00 境界での日跨ぎ分割
      - summary → mst_time_projects.project_nameでプロジェクトマッピング
      - プロジェクト色・クライアントからのカテゴリマッピング
      - キャンセル済みイベント除外
      - fct_time_records_actual_splitと同一列構成

      Use case:
      - 日別集計
      - 日境界での時間分析
    columns:
      - name: id
        description: "ユニークID（{source_id}_{split_index}）"
        data_tests:
          - unique
          - not_null
      - name: source_id
        description: "元のGCal event_id"
        data_tests:
          - not_null
      - name: start_at
        description: "開始時刻（UTC timestamptz、分割後）"
        data_tests:
          - not_null
      - name: end_at
        description: "終了時刻（UTC timestamptz、分割後）"
        data_tests:
          - not_null
      - name: duration_seconds
        description: "時間（秒）"
        data_tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1
      - name: description
        description: "GCalのsummary"
      - name: project_name
        description: "プロジェクト名"
        data_tests:
          - not_null
      - name: project_color
        description: "プロジェクト色（HEX）"
        data_tests:
          - not_null
      - name: tag_names
        description: "タグ名配列（text[]）"
        data_tests:
          - not_null
      - name: social_category
        description: "社会的分類（WORK, LEISURE等）"
        data_tests:
          - not_null
      - name: personal_category
        description: "個人的分類（Work, Study等）"
        data_tests:
          - not_null
      - name: coarse_personal_category
        description: "粗い個人的分類"
        data_tests:
          - not_null
      - name: social_order
        description: "Social分類のソート順"
        data_tests:
          - not_null
      - name: personal_order
        description: "Personal分類のソート順"
        data_tests:
          - not_null
      - name: coarse_order
        description: "粗いPersonal分類のソート順"
        data_tests:
          - not_null
      - name: project_order
        description: "プロジェクトのソート順"
        data_tests:
          - not_null
      - name: source
        description: "データソース"
        data_tests:
          - not_null
          - accepted_values:
              values: ['google_calendar']

