# Core Layer Models
# =============================================================================
# ビジネスエンティティのスキーマ定義とテスト
# =============================================================================

version: 2

models:
  # ===========================================================================
  # Fact Tables
  # ===========================================================================
  - name: fct_time_records_actual
    description: |
      Togglからの実績時間レコード（エントリー単位、分割なし）

      Features:
      - 元のエントリーをそのまま保持（日跨ぎ分割なし）
      - 進行中レコード: end_at = CURRENT_TIMESTAMP (NOT NULL保証)
      - プロジェクト色・クライアントからのカテゴリマッピング
      - 連続時間調整:
        - ギャップ ≤ 5分: end_atを次エントリーのstart_atに延長
        - ギャップ > 5分: 'Untracked'エントリーを挿入
        - オーバーラップ: end_atを次エントリーのstart_atにトリム

      Use case:
      - 睡眠分析（1セッション単位）
      - エントリー単位の所要時間分析
    columns:
      - name: id
        description: "ユニークID（source_id）"
        data_tests:
          - unique
          - not_null
      - name: source_id
        description: "元のToggl time_entry_id（Untrackedは'untracked_{id}'）"
        data_tests:
          - not_null
      - name: start_at
        description: "開始時刻（UTC timestamptz）"
        data_tests:
          - not_null
      - name: end_at
        description: "終了時刻（UTC timestamptz）"
        data_tests:
          - not_null
      - name: duration_seconds
        description: "時間（秒）"
        data_tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1
      - name: description
        description: "Togglのdescription（Untrackedはnull）"
      - name: project_name
        description: "Togglのプロジェクト名（Untrackedはnull）"
      - name: project_color
        description: "Togglのプロジェクト色（HEX、Untrackedはnull）"
      - name: tag_names
        description: "Togglのタグ名配列（text[]）"
      - name: social_category
        description: "社会的分類（WORK, LEISURE, UNKNOWN等）"
        data_tests:
          - not_null
      - name: personal_category
        description: "個人的分類（Work, Sleep, Untracked等）"
        data_tests:
          - not_null
      - name: source
        description: "データソース（toggl_track: Togglから, generated: システム生成）"
        data_tests:
          - not_null
          - accepted_values:
              values: ['toggl_track', 'generated']

  - name: fct_time_records_actual_split
    description: |
      Togglからの実績時間レコード（日分割版）

      Features:
      - JST 00:00:00 境界での日跨ぎ分割
      - 進行中レコード: end_at = CURRENT_TIMESTAMP (NOT NULL保証)
      - プロジェクト色・クライアントからのカテゴリマッピング
      - fct_time_records_actualからの連続時間調整を継承

      Use case:
      - 日別集計
      - 日境界での時間分析
    columns:
      - name: id
        description: "ユニークID（{source_id}_{split_index}）"
        data_tests:
          - unique
          - not_null
      - name: source_id
        description: "元のToggl time_entry_id（Untrackedは'untracked_{id}'）"
        data_tests:
          - not_null
      - name: start_at
        description: "開始時刻（UTC timestamptz、分割後）"
        data_tests:
          - not_null
      - name: end_at
        description: "終了時刻（UTC timestamptz、分割後）"
        data_tests:
          - not_null
      - name: duration_seconds
        description: "時間（秒）"
        data_tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1
      - name: description
        description: "Togglのdescription（Untrackedはnull）"
      - name: project_name
        description: "Togglのプロジェクト名（Untrackedはnull）"
      - name: project_color
        description: "Togglのプロジェクト色（HEX、Untrackedはnull）"
      - name: tag_names
        description: "Togglのタグ名配列（text[]）"
      - name: social_category
        description: "社会的分類（WORK, LEISURE, UNKNOWN等）"
        data_tests:
          - not_null
      - name: personal_category
        description: "個人的分類（Work, Sleep, Untracked等）"
        data_tests:
          - not_null
      - name: source
        description: "データソース（toggl_track: Togglから, generated: システム生成）"
        data_tests:
          - not_null
          - accepted_values:
              values: ['toggl_track', 'generated']

  - name: fct_time_records_target
    description: |
      Google Calendarからの目標時間レコード（エントリー単位、分割なし）

      Features:
      - 元のエントリーをそのまま保持（日跨ぎ分割なし）
      - summary → dim_time_projects.project_nameでプロジェクトマッピング
      - プロジェクト色・クライアントからのカテゴリマッピング
      - キャンセル済みイベント除外
      - fct_time_records_actualと同一列構成

      Use case:
      - エントリー単位の所要時間分析
    columns:
      - name: id
        description: "ユニークID（source_id）"
        data_tests:
          - unique
          - not_null
      - name: source_id
        description: "元のGCal event_id"
        data_tests:
          - not_null
      - name: start_at
        description: "開始時刻（UTC timestamptz）"
        data_tests:
          - not_null
      - name: end_at
        description: "終了時刻（UTC timestamptz）"
        data_tests:
          - not_null
      - name: duration_seconds
        description: "時間（秒）"
        data_tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1
      - name: description
        description: "GCalのsummary"
      - name: project_name
        description: "プロジェクト名"
        data_tests:
          - not_null
      - name: project_color
        description: "プロジェクト色（HEX）"
        data_tests:
          - not_null
      - name: tag_names
        description: "タグ名配列（text[]）"
        data_tests:
          - not_null
      - name: social_category
        description: "社会的分類（WORK, LEISURE等）"
        data_tests:
          - not_null
      - name: personal_category
        description: "個人的分類（Work, Study等）"
        data_tests:
          - not_null
      - name: coarse_personal_category
        description: "粗い個人的分類"
        data_tests:
          - not_null
      - name: social_order
        description: "Social分類のソート順"
        data_tests:
          - not_null
      - name: personal_order
        description: "Personal分類のソート順"
        data_tests:
          - not_null
      - name: coarse_order
        description: "粗いPersonal分類のソート順"
        data_tests:
          - not_null
      - name: project_order
        description: "プロジェクトのソート順"
        data_tests:
          - not_null
      - name: source
        description: "データソース"
        data_tests:
          - not_null
          - accepted_values:
              values: ['google_calendar']

  - name: fct_time_records_target_split
    description: |
      Google Calendarからの目標時間レコード（日分割版）

      Features:
      - JST 00:00:00 境界での日跨ぎ分割
      - summary → dim_time_projects.project_nameでプロジェクトマッピング
      - プロジェクト色・クライアントからのカテゴリマッピング
      - キャンセル済みイベント除外
      - fct_time_records_actual_splitと同一列構成

      Use case:
      - 日別集計
      - 日境界での時間分析
    columns:
      - name: id
        description: "ユニークID（{source_id}_{split_index}）"
        data_tests:
          - unique
          - not_null
      - name: source_id
        description: "元のGCal event_id"
        data_tests:
          - not_null
      - name: start_at
        description: "開始時刻（UTC timestamptz、分割後）"
        data_tests:
          - not_null
      - name: end_at
        description: "終了時刻（UTC timestamptz、分割後）"
        data_tests:
          - not_null
      - name: duration_seconds
        description: "時間（秒）"
        data_tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1
      - name: description
        description: "GCalのsummary"
      - name: project_name
        description: "プロジェクト名"
        data_tests:
          - not_null
      - name: project_color
        description: "プロジェクト色（HEX）"
        data_tests:
          - not_null
      - name: tag_names
        description: "タグ名配列（text[]）"
        data_tests:
          - not_null
      - name: social_category
        description: "社会的分類（WORK, LEISURE等）"
        data_tests:
          - not_null
      - name: personal_category
        description: "個人的分類（Work, Study等）"
        data_tests:
          - not_null
      - name: coarse_personal_category
        description: "粗い個人的分類"
        data_tests:
          - not_null
      - name: social_order
        description: "Social分類のソート順"
        data_tests:
          - not_null
      - name: personal_order
        description: "Personal分類のソート順"
        data_tests:
          - not_null
      - name: coarse_order
        description: "粗いPersonal分類のソート順"
        data_tests:
          - not_null
      - name: project_order
        description: "プロジェクトのソート順"
        data_tests:
          - not_null
      - name: source
        description: "データソース"
        data_tests:
          - not_null
          - accepted_values:
              values: ['google_calendar']

  # ===========================================================================
  # Health Domain
  # ===========================================================================
  - name: fct_health_sleep_actual_timer
    description: |
      Togglタイマーによる睡眠記録（日別集計）

      Features:
      - Sleepプロジェクトのエントリーを日別に集計
      - sleep_date = end_at(JST) - 1日（睡眠は前夜に帰属）
      - 複数エントリーがある場合はstart_at/end_atは最小/最大値

      Use case:
      - 睡眠時間の日別分析
      - 就寝・起床時刻のトレンド分析
    columns:
      - name: id
        description: "ユニークID（sleep_dateから生成したMD5ハッシュ）"
        data_tests:
          - unique
          - not_null
      - name: sleep_date
        description: "睡眠日（起床日の前日、JST基準）"
        data_tests:
          - unique
          - not_null
      - name: start_at
        description: "就寝時刻（UTC timestamptz）"
        data_tests:
          - not_null
      - name: end_at
        description: "起床時刻（UTC timestamptz）"
        data_tests:
          - not_null
      - name: duration_seconds
        description: "睡眠時間（秒）"
        data_tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1
      - name: source_ids
        description: "元のTogglエントリーID配列"
        data_tests:
          - not_null

