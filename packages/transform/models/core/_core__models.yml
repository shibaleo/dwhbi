# Core Layer Models
# =============================================================================
# ビジネスエンティティのスキーマ定義とテスト
# =============================================================================

version: 2

models:
  # ===========================================================================
  # Master Tables
  # ===========================================================================
  - name: mst_time_projects
    description: |
      Togglプロジェクトマスタ（Codaメタデータ統合）

      Features:
      - stg_toggl_track__projects: Toggl APIからのプロジェクトデータ
      - stg_toggl_track__clients: クライアント名
      - stg_coda__mst_toggl_projects: Codaからの補足情報（sort_order, name_ja）
    columns:
      - name: project_id
        description: "TogglプロジェクトID（PK）"
        data_tests:
          - unique
          - not_null
      - name: project_name
        description: "プロジェクト名"
        data_tests:
          - not_null
      - name: project_color
        description: "プロジェクト色（HEX）"
      - name: client_id
        description: "クライアントID（FK）"
      - name: client_name
        description: "クライアント名"
      - name: name_ja
        description: "日本語名（Codaから）"
      - name: description
        description: "説明（Codaから）"
      - name: sort_order
        description: "表示順（Codaから、デフォルト999）"
        data_tests:
          - not_null
      - name: is_active
        description: "アクティブフラグ"
      - name: is_private
        description: "プライベートフラグ"
      - name: is_billable
        description: "請求可能フラグ"
      - name: created_at
        description: "作成日時"
      - name: updated_at
        description: "更新日時"

  - name: mst_personal_time_category
    description: |
      Personal time categoryマスタ（カラーマッピング統合）

      Features:
      - stg_coda__mst_personal_time_category: カテゴリ定義
      - stg_coda__map_toggl_color_to_personal: カラーとカテゴリのマッピング
    columns:
      - name: name
        description: "カテゴリ名（Vitals, Sleep, Work等）"
        data_tests:
          - unique
          - not_null
      - name: name_ja
        description: "日本語名"
      - name: description
        description: "説明"
      - name: coarse_category
        description: "粗いカテゴリ"
      - name: sort_order
        description: "表示順"
        data_tests:
          - not_null
      - name: color_hex_codes
        description: "このカテゴリにマッピングされたTogglカラーHEX（配列）"
      - name: color_names
        description: "このカテゴリにマッピングされたTogglカラー名（配列）"

  - name: mst_social_time_category
    description: |
      Social time categoryマスタ（Togglクライアント統合）

      Features:
      - stg_coda__mst_social_time_category: カテゴリ定義
      - map_toggl_client_to_social: クライアントとカテゴリのマッピング
      - stg_toggl_track__clients: Togglクライアントデータ
    columns:
      - name: name
        description: "カテゴリ名（PRIMARY, SECONDARY等）"
        data_tests:
          - unique
          - not_null
      - name: name_ja
        description: "日本語名"
      - name: description
        description: "説明"
      - name: sort_order
        description: "表示順"
        data_tests:
          - not_null
      - name: client_names
        description: "このカテゴリにマッピングされたTogglクライアント名（配列）"

  # ===========================================================================
  # Fact Tables
  # ===========================================================================
  - name: fct_time_records_actual
    description: |
      Togglからの実績時間レコード（エントリー単位、分割なし）

      Features:
      - 元のエントリーをそのまま保持（日跨ぎ分割なし）
      - 進行中レコード: end_at = CURRENT_TIMESTAMP (NOT NULL保証)
      - プロジェクト色・クライアントからのカテゴリマッピング
      
      Use case:
      - 睡眠分析（1セッション単位）
      - エントリー単位の所要時間分析
    columns:
      - name: id
        description: "ユニークID（source_id）"
        data_tests:
          - unique
          - not_null
      - name: source_id
        description: "元のToggl time_entry_id"
        data_tests:
          - not_null
      - name: start_at
        description: "開始時刻（JST）"
        data_tests:
          - not_null
      - name: end_at
        description: "終了時刻（JST）"
        data_tests:
          - not_null
      - name: duration_seconds
        description: "時間（秒）"
        data_tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1
      - name: description
        description: "Togglのdescription"
      - name: project_name
        description: "Togglのプロジェクト名"
      - name: project_color
        description: "Togglのプロジェクト色（HEX）"
      - name: tag_names
        description: "Togglのタグ名配列（text[]）"
      - name: social_category
        description: "社会的分類（WORK, LEISURE等）"
        data_tests:
          - not_null
      - name: personal_category
        description: "個人的分類（Work, Study等）"
        data_tests:
          - not_null
      - name: source
        description: "データソース"
        data_tests:
          - not_null
          - accepted_values:
              values: ['toggl_track']

  - name: fct_time_records_actual_split
    description: |
      Togglからの実績時間レコード（日分割版）

      Features:
      - JST 00:00:00 境界での日跨ぎ分割
      - 進行中レコード: end_at = CURRENT_TIMESTAMP (NOT NULL保証)
      - プロジェクト色・クライアントからのカテゴリマッピング
      
      Use case:
      - 日別集計
      - 日境界での時間分析
    columns:
      - name: id
        description: "ユニークID（{source_id}_{split_index}）"
        data_tests:
          - unique
          - not_null
      - name: source_id
        description: "元のToggl time_entry_id"
        data_tests:
          - not_null
      - name: start_at
        description: "開始時刻（JST、分割後）"
        data_tests:
          - not_null
      - name: end_at
        description: "終了時刻（JST、分割後）"
        data_tests:
          - not_null
      - name: duration_seconds
        description: "時間（秒）"
        data_tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1
      - name: description
        description: "Togglのdescription"
      - name: project_name
        description: "Togglのプロジェクト名"
      - name: project_color
        description: "Togglのプロジェクト色（HEX）"
      - name: tag_names
        description: "Togglのタグ名配列（text[]）"
      - name: social_category
        description: "社会的分類（WORK, LEISURE等）"
        data_tests:
          - not_null
      - name: personal_category
        description: "個人的分類（Work, Study等）"
        data_tests:
          - not_null
      - name: source
        description: "データソース"
        data_tests:
          - not_null
          - accepted_values:
              values: ['toggl_track']

  - name: fct_time_records_plan
    description: |
      Google Calendarからの計画時間レコード

      Features:
      - JST 00:00:00 境界での日跨ぎ分割
      - イベント色・説明1行目からのカテゴリマッピング
      - キャンセル済みイベント除外
    columns:
      - name: id
        description: "ユニークID（{source_id}_{split_index}）"
        data_tests:
          - unique
          - not_null
      - name: source_id
        description: "元のGCal event_id"
        data_tests:
          - not_null
      - name: start_at
        description: "開始時刻（JST、分割後）"
        data_tests:
          - not_null
      - name: end_at
        description: "終了時刻（JST、分割後）"
        data_tests:
          - not_null
      - name: duration_seconds
        description: "時間（秒）"
        data_tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1
      - name: description
        description: "GCalのsummary"
      - name: social_category
        description: "社会的分類（WORK, LEISURE等）"
        data_tests:
          - not_null
      - name: personal_category
        description: "個人的分類（Work, Study等）"
        data_tests:
          - not_null
      - name: source
        description: "データソース"
        data_tests:
          - not_null
          - accepted_values:
              values: ['google_calendar']

  - name: fct_time_records_unified
    description: |
      actual（実績）とplan（計画）をCURRENT_TIMESTAMP境界で統合

      Boundary rules:
      - end_at <= now: actual（そのまま）
      - start_at < now < end_at: actual（end_at を now に調整）
      - start_at >= now: plan（そのまま）
      - start_at < now < end_at: plan（start_at を now に調整）
    columns:
      - name: id
        description: "ユニークID"
        data_tests:
          - not_null
      - name: source_id
        description: "元のレコードID"
        data_tests:
          - not_null
      - name: start_at
        description: "開始時刻（JST）"
        data_tests:
          - not_null
      - name: end_at
        description: "終了時刻（JST）"
        data_tests:
          - not_null
      - name: duration_seconds
        description: "時間（秒）"
        data_tests:
          - not_null
          - dbt_utils.accepted_range:
              min_value: 1
      - name: description
        description: "説明/タイトル"
      - name: social_category
        description: "社会的分類"
        data_tests:
          - not_null
      - name: personal_category
        description: "個人的分類"
        data_tests:
          - not_null
      - name: source
        description: "データソース"
        data_tests:
          - not_null
          - accepted_values:
              values: ['toggl_track', 'google_calendar']
      - name: record_type
        description: "レコードタイプ（actual/plan）"
        data_tests:
          - not_null
          - accepted_values:
              values: ['actual', 'plan']

  - name: dim_day_types
    description: |
      日タイプディメンション（day_typeを動的導出）

      day_type導出ロジック（ADR-004）:
      - Work >= 5h → Work
      - Drift >= 2h → Drift
      - それ以外: eligible内で最大時間のカテゴリ
    columns:
      - name: date_day
        description: "日付"
        data_tests:
          - unique
          - not_null
      - name: day_of_week
        description: "曜日（0=日曜, 6=土曜）"
        data_tests:
          - not_null
      - name: year
        description: "年"
        data_tests:
          - not_null
      - name: month
        description: "月"
        data_tests:
          - not_null
      - name: day
        description: "日"
        data_tests:
          - not_null
      - name: week_of_year
        description: "ISO週番号"
        data_tests:
          - not_null
      - name: day_type
        description: "日タイプ（Work, Leisure, Education等）"
        data_tests:
          - not_null
      - name: total_hours_recorded
        description: "記録された合計時間"
        data_tests:
          - not_null
