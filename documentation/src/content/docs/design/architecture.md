---
title: システムアーキテクチャ
description: 技術選定とアーキテクチャ設計
---

# システムアーキテクチャ

## 技術スタック

### バックエンド（データパイプライン）

| レイヤー | 技術 | 選定理由 |
|---------|------|---------|
| 言語 | Python 3.12 | 豊富なライブラリ、型ヒント |
| HTTP | httpx | 非同期対応、型安全 |
| DB接続 | supabase-py | Supabase公式 SDK |
| 実行環境 | GitHub Actions | 無料枠、スケジュール実行 |

### フロントエンド（管理ダッシュボード）

| レイヤー | 技術 | 選定理由 |
|---------|------|---------|
| フレームワーク | Next.js 15 (App Router) | RSC、Server Actions |
| UI | shadcn/ui + Tailwind CSS | カスタマイズ性 |
| 状態管理 | React Server Components | サーバーサイドで完結 |
| ホスティング | Vercel | Next.js 最適化 |

### データベース

| レイヤー | 技術 | 選定理由 |
|---------|------|---------|
| RDBMS | PostgreSQL (Supabase) | 無料枠、RLS |
| シークレット | Supabase Vault | 暗号化ストレージ |
| 認証 | Supabase Auth | 管理者認証 |

## アーキテクチャ図

```
┌─────────────────────────────────────────────────────────────────────┐
│                        External Services                             │
├───────────────────────────────────────────────────────────────────────┤
│  Toggl Track  │  Fitbit  │  Zaim  │  Google Calendar  │  etc.        │
└───────┬───────────┬────────┬───────────┬─────────────────────────────┘
        │           │        │           │
        │    REST API / OAuth 2.0        │
        │           │        │           │
┌───────▼───────────▼────────▼───────────▼─────────────────────────────┐
│                    GitHub Actions (Scheduled Jobs)                    │
│  ┌─────────────────────────────────────────────────────────────────┐ │
│  │                    Python Pipelines                              │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐          │ │
│  │  │ toggl.py     │  │ fitbit.py    │  │ zaim.py      │  ...     │ │
│  │  └──────────────┘  └──────────────┘  └──────────────┘          │ │
│  └─────────────────────────────────────────────────────────────────┘ │
└───────────────────────────────┬──────────────────────────────────────┘
                                │
                         supabase-py
                                │
┌───────────────────────────────▼──────────────────────────────────────┐
│                          Supabase                                     │
│  ┌─────────────────────────────────────────────────────────────────┐ │
│  │  PostgreSQL                                                      │ │
│  │  ┌─────────┐  ┌─────────┐  ┌─────────┐  ┌─────────┐           │ │
│  │  │ raw     │→ │ staging │→ │ core    │→ │ marts   │           │ │
│  │  └─────────┘  └─────────┘  └─────────┘  └─────────┘           │ │
│  └─────────────────────────────────────────────────────────────────┘ │
│  ┌─────────────────────────────────────────────────────────────────┐ │
│  │  Supabase Vault (Encrypted Secrets)                             │ │
│  └─────────────────────────────────────────────────────────────────┘ │
│  ┌─────────────────────────────────────────────────────────────────┐ │
│  │  Supabase Auth (Admin Authentication)                           │ │
│  └─────────────────────────────────────────────────────────────────┘ │
└───────────────────────────────┬──────────────────────────────────────┘
                                │
                          Supabase SDK
                                │
┌───────────────────────────────▼──────────────────────────────────────┐
│                     Admin Dashboard (Vercel)                          │
│  ┌─────────────────────────────────────────────────────────────────┐ │
│  │  Next.js 15 (App Router)                                         │ │
│  │  - Server Components                                             │ │
│  │  - Server Actions                                                │ │
│  │  - shadcn/ui                                                     │ │
│  └─────────────────────────────────────────────────────────────────┘ │
└──────────────────────────────────────────────────────────────────────┘
```

## データフロー

### 同期処理フロー

```
1. GitHub Actions が cron でトリガー
2. Python パイプラインが起動
3. Vault から認証情報を取得
4. 必要に応じてトークンリフレッシュ
5. 外部 API からデータ取得
6. raw スキーマに upsert
7. 同期ログを sync_jobs テーブルに記録
```

### 管理ダッシュボードフロー

```
1. 管理者が Supabase Auth でログイン
2. Server Component がデータベースから直接取得
3. Server Action で設定変更を Vault に保存
4. RLS により管理者のみアクセス可能
```

## 設計原則

### 長期運用を見据えた設計

このシステムは個人のライフログを長期間保存・分析することを想定しています。

| 原則 | 説明 |
|------|------|
| サービス非依存 | core層でサービス名を隠蔽し、サービス移行に耐える |
| スキーマ進化 | マイグレーションによる安全な変更 |
| 生データ保存 | raw層にAPI応答を保存し、将来の再処理に対応 |
| 単純な技術選定 | 枯れた技術（PostgreSQL）を優先 |

### セキュリティ

| 対策 | 実装 |
|------|------|
| 認証情報保管 | Supabase Vault（暗号化ストレージ） |
| 通信暗号化 | HTTPS必須 |
| アクセス制御 | RLS（Row Level Security） |
| 最小権限 | 管理者1名のみ |

### コスト最適化

| 項目 | 対策 |
|------|------|
| Supabase | Free/Pro プラン |
| GitHub Actions | 無料枠（2000分/月） |
| Vercel | Hobby プラン |
| 総コスト | $0〜$25/月 |

## コンポーネント間の依存関係

```
┌──────────────────────────────────────────────────┐
│                Admin Dashboard                    │
│  (Next.js / Vercel)                              │
└───────────────┬──────────────────────────────────┘
                │ depends on
┌───────────────▼──────────────────────────────────┐
│                  Supabase                         │
│  - PostgreSQL (raw/staging/core/marts)           │
│  - Vault (credentials)                            │
│  - Auth (admin login)                             │
└───────────────┬──────────────────────────────────┘
                │ accessed by
┌───────────────▼──────────────────────────────────┐
│              Python Pipelines                     │
│  (GitHub Actions)                                 │
└───────────────┬──────────────────────────────────┘
                │ fetches from
┌───────────────▼──────────────────────────────────┐
│            External Services                      │
│  (Toggl, Fitbit, Zaim, etc.)                     │
└──────────────────────────────────────────────────┘
```

## 変更履歴

| 日付 | 変更内容 |
|------|---------|
| 2025-12-01 | 初版作成 |
