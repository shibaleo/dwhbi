---
title: 組成データの距離指標
description: 時間配分のような組成データにおけるtarget-actual比較の指標設計
---

# 組成データの距離指標

一日の時間配分（24時間固定）のような**組成データ (Compositional Data)** において、target（計画）と actual（実績）の乖離を評価する指標の設計ナレッジ。

## 背景・課題

時間配分データの特性:
- 合計が固定値（24時間）に制約される
- あるカテゴリが増えれば、他が減る（完全従属）
- 通常の統計手法（共分散行列など）は特異行列になり適用不可

## 検討した指標

### スケール依存指標

| 指標 | 定義 | 評価 |
|------|------|------|
| MAE | `Σ\|actual - target\| / n` | 合計制約を考慮しない |
| RMSE | `√(Σ(actual - target)² / n)` | 同上 |

### パーセント誤差系

| 指標 | 定義 | 評価 |
|------|------|------|
| MAPE | `Σ\|actual - target\| / actual / n` | target=0で破綻 |
| sMAPE | `Σ\|A - T\| / (\|A\| + \|T\|) × 2 / n` | 対称的だが批判あり |

### スケール不変指標

| 指標 | 定義 | 評価 |
|------|------|------|
| Theil's U | `RMSE / (RMS_A + RMS_T)` | 経済予測で標準 |
| MASE | `MAE / naive_MAE` | 時系列向け |
| R² | `1 - SS_res / SS_tot` | 合計制約を考慮しない |

### 多変量指標

| 指標 | 定義 | 評価 |
|------|------|------|
| Mahalanobis距離 | `√((x-μ)ᵀΣ⁻¹(x-μ))` | 合計制約で共分散行列が特異に |

### 組成データ専用指標

| 指標 | 定義 | 評価 |
|------|------|------|
| Aitchison距離 | `√(Σ(log(xᵢ/g(x)) - log(yᵢ/g(y)))²)` | 組成データ分析の標準 |
| Bray-Curtis | `Σ\|actual - target\| / Σ(actual + target)` | 生態学で使用、シンプル |

### 確率分布間の距離

| 指標 | 定義 | 評価 |
|------|------|------|
| JSD | `(KL(P\|\|M) + KL(Q\|\|M)) / 2` | 情報理論的、カテゴリ間距離を考慮しない |
| Wasserstein距離 | `min Σ Tᵢⱼ × d(i,j)` | カテゴリ間の移動コストを考慮 |
| Sliced Wasserstein | 1次元投影の平均 | 高次元で高速だがk<20なら不要 |

## 採用指標: Wasserstein距離 (Earth Mover's Distance)

### 選定理由

1. **合計制約の適切な扱い**: 組成データを確率分布とみなし比較
2. **カテゴリ間距離の考慮**: 「仕事→趣味」と「仕事→睡眠」を区別できる
3. **解釈性**: 「実績を計画に一致させるには、カテゴリ間で何時間を移動させる必要があるか」という直感的意味
4. **理論的背景**: 最適輸送理論に基づく確立された指標

### 計算方法

```
W(P, Q) = min Σᵢⱼ Tᵢⱼ × Cᵢⱼ

subject to:
  Σⱼ Tᵢⱼ = Pᵢ  (supply制約)
  Σᵢ Tᵢⱼ = Qⱼ  (demand制約)
  Tᵢⱼ ≥ 0

where:
  P = target分布 (各カテゴリのtarget時間 / 24)
  Q = actual分布 (各カテゴリのactual時間 / 24)
  C = コスト行列 (カテゴリ間の移動コスト)
  T = 輸送計画 (最適化で求める)
```

### 計算量

| 手法 | 計算量 | 用途 |
|------|--------|------|
| 線形計画法 | O(k³) | k < 20 で実用的 |
| Sinkhorn | O(k² / ε²) | 近似、微分可能 |
| Sliced | O(n × k log k) | k > 100 向け |

本ケース（k=10）では線形計画法で十分。

## コスト行列の設計

Wasserstein距離にはカテゴリ間のコスト行列 C が必要。

### 非対称コスト行列の必要性

時間配分の変動には方向性がある:

| 遷移 | 難易度 | 理由 |
|------|--------|------|
| 自由時間 → 仕事 | 容易 | 仕事が入れば自由時間は自然に削られる |
| 仕事 → 自由時間 | 困難 | 意志力が必要 |
| 睡眠 → 自由時間 | 短期容易/長期困難 | 睡眠負債になる |
| 自由時間 → 睡眠 | 中程度 | 意識的に早寝する必要 |

→ **コスト行列は非対称** (`C[i,j] ≠ C[j,i]`) であるべき

### 設計アプローチ

| 方法 | 説明 | 適用場面 |
|------|------|----------|
| 手動定義 | ドメイン知識で直接指定 | カテゴリ数が少ない場合 |
| 階層構造 | カテゴリ木の経路長 | 明確な分類体系がある場合 |
| 埋め込み | 特徴ベクトル間のユークリッド距離 | 属性で表現できる場合 |
| データ駆動 | 過去データから学習 | 十分なデータがある場合 |

→ 本プロジェクトでは **データ駆動（フロー行列推定）** を採用。詳細は [time-flow-matrix-design.md](../01-product/100-development/120-specifications/125-analyzer/time-flow-matrix-design.md) を参照。

## 参考文献

- Villani, C. (2008). *Optimal Transport: Old and New*
- Peyré, G., & Cuturi, M. (2019). *Computational Optimal Transport*
- Aitchison, J. (1986). *The Statistical Analysis of Compositional Data*
