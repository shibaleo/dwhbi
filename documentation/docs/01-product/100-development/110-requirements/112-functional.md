---
title: 機能要件
description: システムが提供すべき機能の一覧
---

# 機能要件

## スコープ外

以下の機能はスコープ外とする。

| 機能 | 理由 |
|------|------|
| draft（目標草案）の値の算出 | ユーザー自身が願望・理想として決定する |
| 可視化（ダッシュボード描画・定義） | Grafana等の外部ツールを利用 |
| インサイトの解釈・意思決定 | ユーザーまたはLLMが行う |

---

## 1. データ自動収集

外部サービスからデータを自動的に収集する。

### 1.1 サービス連携
- 各外部サービスのAPIを利用してデータを取得する
- OAuth認証が必要なサービスの認証フローをサポートする
- APIキー認証のサービスをサポートする

### 1.2 定期同期
- 設定されたスケジュールに従い自動的にデータを同期する
- 手動での即時同期をサポートする
- 差分同期（前回同期以降の変更のみ取得）をサポートする

### 1.3 エラーハンドリング
- API呼び出し失敗時にリトライする
- レート制限に対応する
- 同期エラーをログに記録する

---

## 2. データ変換

収集したデータを分析可能な形式に変換する。

### 2.1 DWH層構造
- Raw層: 外部APIからの生データをそのまま保存（JSONB形式）
- Staging層: クレンジング・正規化済みデータ（型変換、タイムゾーン統一）
- Core層: ビジネスロジック適用済み・サービス統合済みデータ（actual, draft, estimate, target）
- Mart層: 分析・可視化用に集計されたデータ

### 2.2 スキーマ正規化
- 各サービス固有のデータ形式を共通スキーマに変換する
- タイムゾーンを統一する（JST基準）

### 2.3 データクレンジング
- 重複データを排除する
- 欠損値を適切に処理する

### 2.4 履歴管理

#### 設計方針

**外部サービスのデータが正（Single Source of Truth）** である。

- 外部サービス由来のデータ（raw層）: 履歴を残さない（上書き）
- 本システム内部で生成するデータ（target, estimate）: 履歴を残す

ユーザーが外部サービス上でデータを変更すれば、次回同期時に本システムのデータも更新される。過去の外部データを参照したい場合は、外部サービス自体の履歴機能を利用する。

#### データ種別ごとの管理方式

| データ種別 | データ源 | 履歴管理 | 備考 |
|-----------|---------|:--------:|------|
| raw層 | 外部サービス | ✗ | エンティティごとに上書き、外部サービスが正 |
| staging層 | raw層からビュー派生 | ✗ | 正規化・型変換のみ |
| core層 | staging + seeds + ビジネスロジック | ✗ | マスタによるユーザ定義値、サービス統合 |
| marts層 | core層からビュー派生 | ✗ | 集計・分析用 |
| target（目標値） | 本システム | ✓ SCD Type 2 | 変更履歴を保持、過去の目標値を参照可能 |
| estimate（推定値） | 本システム | ✓ スナップショット | 算出時点の値をJSONBで保存 |
| 同期ログ | 本システム | ✓ 追記のみ | sync_logs に実行履歴を記録 |

---

## 3. データ分析

蓄積したデータを分析し、推定値を算出する。

### 3.1 推定値算出（analyze）

実績データ（actual）を基に、推定値（estimate）を自動算出する。QPIモデルの`analyze`プロセスに相当する。

### 3.2 テキストデータ分析

テキストベースのデータ（日記、メモ等）から情報を抽出し、推定値の材料として活用する。

| データソース | 抽出内容 | 用途 |
|-------------|---------|------|
| Obsidian（Markdown） | 気分、行動パターン、キーワード | 行動予測、パターン分析 |
| Notion（エクスポート） | 日記内容、振り返り | 傾向分析、estimate補正 |

- **処理方式**: LLM/MLによる自然言語処理
- **出力**: 構造化データとしてDBに保存し、他のestimate算出の入力として利用

### 3.3 分析ビュー

marts層で集計・分析用ビューを提供する。可視化は外部ツール（Grafana等）で行う。

---

## 4. 目標値自動調整

draft（目標草案）を基に、LLMがtarget（目標値）を自動生成する。QPIモデルの`adjust`プロセスに相当する。

### 4.1 入力データ

| データ | 説明 |
|--------|------|
| draft | ユーザーが設定した目標草案（理想・願望） |
| estimate | 過去実績から算出された推定値 |
| actual履歴 | 直近の実績データ（傾向把握用） |
| ユーザー傾向 | 達成率、曜日別パターン、過去の乖離傾向 |
| 外部制約 | 予定、休日、イベント等 |

### 4.2 出力

- target: 現実的制約で調整された目標値
- 調整理由: LLMによる判断根拠（ログ用）

### 4.3 実行方式

- **トリガー**: draftの更新時 / 日次バッチ
- **LLM**: Groq (Llama) 等の無料・低コストAPIを利用
- **出力形式**: JSON形式で構造化し、DBに直接書き込み

---

## 5. 管理機能

システムの設定・運用を行う管理コンソールを提供する。

### 5.1 draft入力

ユーザーが目標草案（draft）を入力・編集するUIを提供する。

- ドメイン別（時間、金銭、健康等）のdraft設定
- 期間（週次、月次等）ごとのdraft設定
- 入力履歴の確認

### 5.2 マスタ管理

マスタデータは **変更可能性** によって分離する。

| 種類 | 例 | 管理方法 |
|-----|-----|---------|
| 静的マスタ | サービス固有の固定値（APIで取得不可） | 本プロジェクトで定義 |
| 動的マスタ | 分析軸の定義、サービス固有値のマッピング | 管理コンソールでCRUD |

### 5.3 サービス管理
- 連携サービスの一覧表示
- サービスごとの認証情報（APIキー、OAuthトークン）の登録・更新
- サービスごとの同期設定（有効/無効、スケジュール）

### 5.4 同期ログ管理
- 同期実行履歴の一覧表示
- エラーログの確認
- 同期統計（取得レコード数、所要時間など）

### 5.5 ユーザー管理
- オーナーユーザーの登録（初回セットアップ時）
- パスワード認証によるログイン

---

## 6. セキュリティ機能

### 6.1 認証
- パスワードベースの認証
- セッション管理

### 6.2 認可
- オーナーのみがすべての機能にアクセス可能
- 未認証ユーザーはアクセス不可

### 6.3 データ保護
- 認証情報（APIキー、トークン）の暗号化保存
- HTTPS通信の強制
