---
title: DWH 4層アーキテクチャ
description: エンタープライズ向けDWH設計を個人プロジェクトに適用する設計哲学
sidebar:
  order: 24
---

# DWH 4層アーキテクチャ

## 設計哲学

エンタープライズ向けのデータウェアハウス設計パターンを、個人向け小規模プロジェクトに適用する。これにより、データの流れが明確になり、将来のサービス変更にも柔軟に対応できる。

## 層構造の概念

```
┌─────────────────────────────────────────────────────────────────────┐
│ marts.*                                                             │
│   分析・集計ビュー                                                  │
│   agg_daily_health, agg_weekly_productivity                         │
└─────────────────────────────────────────────────────────────────────┘
                                    ▲
┌─────────────────────────────────────────────────────────────────────┐
│ core.*                                                              │
│   サービス統合（サービス名が消える）                                │
│   fct_time_entries, fct_transactions, dim_categories                │
└─────────────────────────────────────────────────────────────────────┘
                                    ▲
┌─────────────────────────────────────────────────────────────────────┐
│ staging.*                                                           │
│   クリーニング・正規化済み                                          │
│   stg_toggl__entries, stg_zaim__transactions                        │
└─────────────────────────────────────────────────────────────────────┘
                                    ▲
┌─────────────────────────────────────────────────────────────────────┐
│ raw.*                                                               │
│   外部APIからの生データ                                             │
│   toggl_entries, zaim_transactions, fitbit_sleep                    │
└─────────────────────────────────────────────────────────────────────┘
```

## 各層の役割

| 層 | 役割 | サービス名 | 形式 |
|----|------|-----------|------|
| raw | APIレスポンスをそのまま保存 | あり | テーブル |
| staging | 型変換、列名正規化、TZ変換 | あり | ビュー |
| core | 複数サービスの統合 | **なし** | テーブル |
| marts | 分析・集計、ドメイン別 | なし | ビュー |

## サービス非依存の設計

core層以降ではサービス名が消える：

- 将来Toggl Trackから別サービスに移行しても、core/marts層は変更不要
- 分析クエリはcoreスキーマ以降を参照し、データソースを意識しない
- staging層からcore層への変換プロセスで新旧サービスを統合するロジックを吸収

この設計により、外部サービスへの依存を最小限に抑え、長期的なデータ資産の保全が可能になる。さらに、サービスに縛られないドメインごとのデータモデル（時間、金銭、健康等）を確立できる。

## core層の設計方針：QPIモデルに基づく4 information

core層のテーブル設計は、[QPIモデル](../010-theory/011-qpi-model)の4 informationに基づいて設計する。

### 4 information とテーブルの対応

| information | 説明 | テーブル例 | 備考 |
|-------------|------|-----------|------|
| **actual** | 実際に記録された値 | `fct_time_actual` | Toggl等の実績 |
| **estimate** | 過去実績から導出された推定 | `fct_time_estimates` | カテゴリ別推定時間 |
| **draft** | 理想・願望を含む目標 | `fct_time_drafts` | ユーザが設定 |
| **target** | 現実的制約で調整した目標 | `fct_time_targets` | 調整済み目標時間 |

### 設計原則

1. **information typeの明示**: 各テーブルがどのinformationに対応するかを明確にする
2. **段階的拡張**: actualから始め、必要に応じてestimate → draft → targetを追加

### ドメイン別の適用

| ドメイン | actual | estimate | draft | target |
|---------|--------|----------|-------|--------|
| 時間 | Toggl実績 | 推定作業時間 | Calendar予定 | 調整済み目標 |
| 金銭 | Zaim実績 | 推定支出 | 予算草案 | 確定予算 |
| 健康 | Fitbit実績 | 推定消費カロリー | 運動計画 | 目標値 |

この設計により、ドメインを問わず「実績と目標の乖離分析」「推定精度の検証」といった分析が統一的に行える。

## 技術仕様

詳細な技術仕様（rawテーブルのスキーマ、命名規則、マイグレーション戦略、テーブル一覧）については、[121 DWH技術仕様](/01-product/100-development/120-specifications/121-overview/dwh-layers)を参照。
